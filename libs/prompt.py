from typing import List, Optional


def build_prompt(items: List[str] | None = [], ignore_items: List[str] | None = [], chat: List[str] | None = []) -> str:
    
    items = str(items)
    ignore_items = str(ignore_items)
    chat = str(chat)

    prompt = f'''# OrderMind Prompt

    당신은 채팅에서 **주문번호, 제품명, 수량**을 추출하는 AI입니다.\
    출력은 **JSON 하나만** 생성해야 하며, 다른 설명은 금지합니다.\
    작은 모델(27B)도 이해할 수 있도록 짧고 명확하게 작성되어 있습니다.

    ---

    ## 1. 목표

    - 채팅에서 주문번호(4자리), 제품명, 수량을 추출\
    - 오타·줄임말·발음 유사 단어도 제품명과 매칭\
    - JSON만 출력

    ---

    ## 2. 입력 채팅 형식 (중요)

    채팅은 다음 구조를 여러 줄로 입력받습니다:

        YYYY. M. D. HH:MM, 닉네임 : 채팅내용

    예:

        ['2025. 6. 18. 19:38, 금호어울림7901 : 방울토마토1 문어슬라이스1 막창2 우유1 / 7901', '2025. 6. 18. 19:40, 손님A : 새우살 2개 / 1597']

    규칙: - 날짜/닉네임은 참고용이며 주문 분석에는 영향을 주지 않음\

    - 실제 주문 정보는 **채팅내용 부분만** 사용\
    - 여러 줄이 주어질 수 있음

    ---

    ## 3. 제품명 리스트

    아래 이름만 "정확한 제품명"으로 인정합니다.

        {items}

    ---

    ## 3-1. 제외 제품명

    아래 단어가 포함되면 제품으로 취급하지 않습니다.

        {ignore_items}

    부분 일치도 제외합니다.

    ---

    ## 4. 기능 타입 (하나만 선택)

    ### A) gotoTrash

    제품 매칭이 거의 없을 때.

        "function": {{ "gotoTrash": true }}

    ### B) getLineForNumber

    특정 주문번호가 포함된 채팅 줄만 필요할 때.

        "function": {{ "getLineForNumber": "1234" }}

    ### C) saveToExcel

    주문번호와 제품들을 추출할 때.

        "function": {{
        "saveToExcel": {{
            "number": "1234",
            "items": {{
            "정확제품명": "수량"
            }}
        }}
        }}

    ---

    ## 5. 최종 출력 JSON 형식

        {{
        "accuracy": "85%",
        "function": {{ ... }},
        "특이사항": "10자 이내로"
        }}

    규칙: - JSON 외 텍스트 금지\

    - accuracy는 % 문자열\
    - 특이사항 없으면 ""

    ---

    ## 6. 채팅 데이터

    여기에 채팅 여러 줄이 제공됩니다.

        {chat}
    '''

    return prompt


# 한 닉네임에 여러 주문번호가 있는 채팅 주문을 종합하는 프롬프트
def build_prompt2(items: List[str] | None = [], ignore_items: List[str] | None = [], chat: str | None = []) -> str:
    
    items = str(items)
    ignore_items = str(ignore_items)
    chat = str(chat)

    prompt = f'''# 주문 메시지 → JSON 변환 지침 (확정/불확정 분리 버전)

    당신은 채팅에서 **주문번호, 제품명, 수량**을 추출하는 AI입니다.  
    출력은 **JSON 하나만** 해야 합니다.  
    다른 설명, 문장, 코멘트는 출력 금지입니다.

    ---

    # 📌 전체 출력 구조

    출력은 반드시 다음 형태의 **JSON 객체 하나**입니다:

    ```json
    {{
    "orders": [
        {{
        "number": "주문번호",
        "items": {{ "정확제품명": "수량" }},
        "raw_messages": ["원본 메시지1", "원본 메시지2"]
        }}
    ],
    "uncertain": [
        {{
        "nickname": "닉네임",
        "timestamp": "날짜",
        "reason": "왜 불확정인지 간단 설명",
        "message": "원본 메시지"
        }}
    ]
    }}
    ```

    ---

    # 📌 입력 형식
    입력은 여러 줄로 이루어진 채팅 로그입니다:

    ```
    {{날짜}} {{닉네임}} : {{메시지}}
    ```

    - 주문 `메시지`는 `(상품 이름과 수량) (주문번호)` 이러한 형태로 이루어져 있음.
    - `메시지` 양식은 위 양식과 항상 정확하지 않을 수 있는 자연어 데이터이므로 유연하게 처리할 것.
    - 주문번호가 생략된 메시지도 존재할 수 있으며, 이는 해당 메시지의 타임스탬프를 고려하여 주문번호를 추측 후, "수정/추가/취소" 문맥의 주문으로 간주합니다.

    > 예시
    ```
    20XX-XX-XX 닉네임1 : 상품_1 2, 상품_2 1, 상품_3 1 / 1234
    20XX-XX-XX 닉네임2 : 상품_1 1  1234
    ```

    ---

    # 📌 확정 여부 판단 규칙

    ### ✅ 확정(orders 배열로 들어가는 경우)
    - 주문 메시지의 주문번호가 생략되어 있어도 이전 메시지들과 자연스럽게 이어질 수도 있음.
        - `주의` : 타임스탬프가 너무 떨어져 있어서 주문번호 추측이 어려우면 불확정으로 간주함.
    - "최종:" 이 붙은 경우는 해당 주문번호의 최우선 정보
    - 메시지 양식이 정확하지 않아도 어느정도 유연하게 대처

    ### ⚠️ 불확정(uncertain 배열로 들어가는 경우)
    - 주문 메시지에 **주문번호가 없음**
    - 최근 동일 닉네임의 주문번호가 여러 개 있어 귀속이 불명확
    - 문장 자체가 **상품명 + 수량 패턴**을 띠지만 번호를 특정할 수 없음  
    예:  
    `<제품명>1 추가요`  
    → 어느 주문번호에 대한 "추가"인지 유추 불가

    ### `어떠한 배열`(orders, uncertain) 에도 들어가면 안 되는 경우
    - 잡담이나 문의에 관한 채팅이었다면 uncertain 배열에도 넣지 말고 무시할 것.
    - `제외 제품명`에 해당하는 주문일 경우에 무시할 것.

    ---

    # 📌 items 처리 규칙

    1. 아이템명은 입력된 **제품명 + 키워드** 기반으로 매칭
    2. 수량 미기재 시 기본값 `"1"` 로 예측
    3. 하나의 주문번호에 여러 메시지가 관련될 경우  
    `"raw_messages"`에 모두 포함시키고 최종 `"items"`는 결론만 정리
    4. 키워드는 띄어쓰기·오타·반각/전각 헷갈리는 경우에도 유사 매칭
    5. 메시지를 총 종합한 결과로 items에 들어갈 결론이 없으면 `{{}}` 로 공백 표시

    ---

    # 📦 상품 데이터

    ```
    제품명
    제품명2:키워드1, 키워드2

    ### 주의할 점
    - JSON 출력 시 키워드를 출력하지 않고, 오직 정확한 제품명만 출력합니다.
    ...
    ```

    {items}

    ---

    # 제외 제품명

    아래 단어가 포함되면 제품으로 취급하지 않습니다.

        {ignore_items}

    부분 일치도 제외합니다.

    ---

    # 💬 입력 채팅 로그
    여기에 채팅 여러 줄을 붙여 넣으세요:

    ```
    {chat}
    ```

    ---

    # 🎯 출력 요구사항 (매우 중요)

    출력은 오직 하나:

    ```
    {{
    "orders": [...],
    "uncertain": [...]
    }}
    ```

    그 외 한 글자도 출력하면 안 됩니다.


    '''

    return prompt

# 주문번호와 닉네임이 1:1 매칭되는 주문 전용 프롬프트
def build_prompt3(items: List[str] | None = [], ignore_items: List[str] | None = [], chat: str | None = []) -> str:
    
    items = str(items)
    ignore_items = str(ignore_items)
    chat = str(chat)

    prompt = f'''# OrderMind 1:1 단일 주문 종합 프롬프트

    당신은 아래 채팅에서 **단 하나의 주문**을 완성하는 AI입니다.  
    주문번호와 닉네임은 **1:1로 고정되어 있으며 중복되지 않습니다.**  
    따라서 모든 메시지는 동일 주문번호에 귀속됩니다.

    ---

    # 📌 전체 출력 구조

    출력은 반드시 다음 형태의 **JSON 객체 하나**입니다:

    ```json
    {{
    "orders": [
        {{
        "number": "주문번호",
        "items": {{ "정확제품명": "수량" }},
        "raw_messages": ["원본 메시지1", "원본 메시지2"]
        }}
    ],
    "uncertain": [
        {{
        "nickname": "닉네임",
        "timestamp": "날짜",
        "reason": "왜 불확정인지 간단 설명",
        "message": "원본 메시지"
        }}
    ]
    }}
    ```

    ---

    # 📌 입력 형식
    입력은 여러 줄로 이루어진 채팅 로그입니다:


    ```
    {{날짜}} {{닉네임}} : {{메시지}}
    ```

    - 주문 `메시지`는 `(상품 이름과 수량) (주문번호)` 이러한 형태로 이루어져 있음.
    - `메시지` 양식은 위 양식과 항상 정확하지 않을 수 있는 자연어 데이터이므로 유연하게 처리할 것.
    - 주문번호가 생략된 메시지도 존재할 수 있으며, 이는 모두 동일 주문의 "수정/추가/취소" 문맥으로 간주합니다.

    > 예시
    ```
    20XX-XX-XX 닉네임1 : 상품_1 2, 상품_2 1, 상품_3 1 / 1234
    20XX-XX-XX 닉네임2 : 상품_1 1  1234
    ```

    ---

    # 📌 확정 여부 판단 규칙

    ### ✅ 확정(orders 배열로 들어가는 경우)
    - 동일 주문번호의 이전 메시지들과 자연스럽게 이어짐
    - "최종:" 이 붙은 경우는 해당 주문번호의 최우선 정보
    - 메시지 양식이 정확하지 않아도 어느정도 유연하게 대처

    ### ⚠️ 불확정(uncertain 배열로 들어가는 경우)
    - 주문 목록 중에, 주어진 상품 데이터와 매치가 되지 않는 데이터가 있을 경우

    ### `어떠한 배열`(orders, uncertain) 에도 들어가면 안 되는 경우
    - 채팅이 잡담이나 문의성 메시지일 경우에 uncertain 배열에도 넣지 말고 무시할 것.
    - 채팅이 `제외 제품명`에 해당하는 주문일 경우에 uncertain 배열에도 넣지 말고 무시할 것.

    ---

    # 📌 items 처리 규칙

    1. **모든 메시지는 단일 주문번호에 종속됩니다.**  
    주문번호가 없는 메시지도 동일 주문의 수정으로 간주합니다.

    2. **아이템 합산 규칙**
    - “추가요”, “하나 더”, “1 더” 등 → 수량 증가  
    - “빼주세요”, “취소요”, “제외” → 해당 제품 제거  
    - “구구 빼고 마이키파제로 1 추가요” → 두 동작 모두 반영  
    - 제품명이 오타/축약/키워드여도 상품 데이터로 매칭

    3. **최종 items는 전체 메시지를 반영한 결과만 남깁니다.**  
    raw_messages에는 모든 원본 메시지를 순서대로 기록합니다.

    4. 메시지를 총 종합한 결과로 items에 들어갈 결론이 없으면 `{{}}` 로 공백 표시

    ---

    # 📦 상품 데이터

    ```
    제품명
    제품명2:키워드1, 키워드2

    ### 주의할 점
    - JSON 출력 시 키워드를 출력하지 않고, 오직 정확한 제품명만 출력합니다.
    ...
    ```

    {items}

    ---

    # 제외 제품명

    아래 단어가 포함되면 제품으로 취급하지 않습니다.

        {ignore_items}

    부분 일치도 제외합니다.

    ---

    # 💬 입력 채팅 로그
    여기에 채팅 여러 줄을 붙여 넣으세요:

    ```
    {chat}
    ```

    ---

    # 🎯 출력 요구사항 (매우 중요)

    출력은 오직 하나:

    ```
    {{
    "orders": [...],
    "uncertain": [...]
    }}
    ```

    그 외 한 글자도 출력하면 안 됩니다.


    '''

    return prompt

if __name__ == '__main__':

    print(build_prompt(["안녕하세요", "안녕하세요", "안녕하세요"]))